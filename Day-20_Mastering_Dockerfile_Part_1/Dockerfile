# ğŸ—ï¸ Base stage for builder
FROM python:3.10-slim AS builder

# âš™ï¸ Build-time argument
ARG INSTALL_ENV=prod

# ğŸ§¨ ONBUILD trigger for child Dockerfiles
ONBUILD RUN echo "This is a base image with ONBUILD trigger."

# ğŸš Set default shell
SHELL ["/bin/bash", "-c"]

# ğŸ“¦ Add external or archive files
ADD https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh /wait-for-it.sh

# ğŸ“ Copy app files
COPY ./app /app

# ğŸ·ï¸ Labels for metadata
LABEL maintainer="DevOps In Action"
LABEL version="1.0"
LABEL description="A Docker image demonstrating all instructions"

# ğŸŒ Environment variables
ENV APP_HOME=/app \
    FLASK_ENV=development

# ğŸ“‚ Working directory
WORKDIR $APP_HOME

# ğŸ”§ Install dependencies
RUN apt-get update && \
    apt-get install -y curl iputils-ping && \
    pip install flask && \
    chmod +x /wait-for-it.sh

# ğŸ’¾ Define a volume
VOLUME ["/data"]

# ğŸ› ï¸ Default command
CMD ["python", "main.py"]

# ğŸšª Set entrypoint
ENTRYPOINT ["python", "main.py"]

# ğŸ›‘ Graceful shutdown signal
STOPSIGNAL SIGINT

# ğŸ‘¥ Run as root (default in most cases, explicitly shown)
USER root

# ğŸ“¡ Expose port
EXPOSE 5000

# ğŸ©º Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s \
  CMD curl -f http://localhost:5000/ping || exit 1
